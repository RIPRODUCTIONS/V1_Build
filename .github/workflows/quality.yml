name: quality
on:
  pull_request:
  push:
    branches: [ master, main ]

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r backend/requirements.txt || true
      - name: Ruff
        run: |
          pip install ruff
          ruff check
      - name: Pytest
        run: |
          PYTHONPATH=backend pytest -q

  prod-fail-fast:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install API runtime
        run: |
          python -m pip install -U pip
          pip install -r backend/requirements.txt || true
      - name: Assert fail-fast without secrets (ENV=production)
        env:
          ENV: production
        run: |
          set -e
          python - << 'PY'
import sys
try:
    import importlib
    m = importlib.import_module('backend.app.main')
    # If import succeeds, ensure create_app raises in production
    try:
        m.create_app()
    except Exception as e:
        print("Got expected failure:", e)
        sys.exit(0)
    print('ERROR: App booted unexpectedly in production without secrets')
    sys.exit(1)
except Exception as e:
    # Import itself may fail fast; also acceptable
    print("Import error (acceptable):", e)
    sys.exit(0)
PY

  dast-tight:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Start API for ZAP baseline
        run: |
          python -m pip install -U pip
          pip install -r backend/requirements.txt || true
          export PYTHONPATH=backend
          nohup uvicorn backend.app.main:app --host 127.0.0.1 --port 8000 >/tmp/api.log 2>&1 &
          sleep 3
      - name: ZAP baseline (block unallowlisted High)
        run: bash scripts/ci/run_zap_blocking.sh http://127.0.0.1:8000 scripts/ci/zap-allowlist.txt

  npm-audit-high:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Audit frontend dependencies (block on high)
        working-directory: apps/web
        run: |
          npm ci
          npm audit --audit-level=high

